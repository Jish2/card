<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bateman Card Builder</title>
    <link rel="icon" type="image/png" href="/bateman-favicon.png" />
    <link rel="preconnect" href="https://card.jgoon.com" crossorigin />
    <link
      rel="preload"
      href="https://card.jgoon.com/Garamond%20Classico%20SC.ttf"
      as="font"
      type="font/ttf"
      crossorigin
    />
    <style>
      :root {
        color-scheme: only light;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Helvetica Neue", Arial, sans-serif;
        background: #0e1012;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: radial-gradient(circle at 10% 10%, #171a1d, #090a0b 62%);
        color: #f8fafc;
      }

      main {
        flex: 1;
        position: relative;
        padding: 0;
      }

      .promo-banner {
        margin-top: 24px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New",
          monospace;
        font-size: 12px;
        color: #a1a6aa;
        text-decoration: underline;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        text-align: center;
        position: absolute;
        z-index: 1;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 18px;
        background: #ffffff;
      }

      .preview-frame-wrapper {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        border: none;
        background: #111316;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .preview-frame-wrapper iframe {
        flex: 1;
        width: 100%;
        border: none;
        background: #fff;
      }

      [data-field-editor] {
        caret-color: #2f2b25;
        cursor: text;
      }

      [data-field-editor]:focus {
        outline: none;
        box-shadow: inset 0 -2px 0 rgba(56, 189, 248, 0.35);
      }

      .overlay-controls {
        position: fixed;
        left: 50%;
        bottom: 40px;
        transform: translateX(-50%);
        z-index: 2;
        display: flex;
        flex-direction: row;
        gap: 12px;
        align-items: center;
      }

      button {
        appearance: none;
        border: 1px solid rgba(148, 163, 184, 0.28);
        border-radius: 12px;
        background: rgba(15, 17, 19, 0.92);
        color: rgba(248, 250, 252, 0.85);
        font-weight: 500;
        letter-spacing: 0.12em;
        padding: 0 32px;
        cursor: pointer;
        font-size: 12px;
        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        transition: transform 0.14s ease, box-shadow 0.14s ease,
          background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        white-space: nowrap;
        box-shadow: 0 24px 42px rgba(6, 9, 16, 0.45),
          inset 0 1px 0 rgba(248, 250, 252, 0.08);
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        height: 48px;
      }

      .overlay-controls button svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
        display: block;
      }

      button:hover {
        transform: translateY(-1px);
        background: rgba(18, 20, 23, 0.92);
        color: rgba(248, 250, 252, 0.92);
        border-color: rgba(148, 163, 184, 0.38);
        box-shadow: 0 28px 52px rgba(6, 9, 16, 0.55),
          inset 0 1px 0 rgba(248, 250, 252, 0.12);
      }

      button:active {
        transform: translateY(0);
        background: rgba(12, 14, 16, 0.94);
        border-color: rgba(148, 163, 184, 0.24);
        box-shadow: 0 16px 32px rgba(6, 9, 16, 0.45),
          inset 0 1px 0 rgba(248, 250, 252, 0.08);
      }

      button:disabled,
      button:disabled:hover,
      button:disabled:active {
        cursor: not-allowed;
        opacity: 0.42;
        transform: none;
        border-color: rgba(148, 163, 184, 0.18);
        box-shadow: none;
        background: rgba(15, 17, 19, 0.72);
        color: rgba(148, 163, 184, 0.6);
      }

      @media (max-width: 640px) {
        button {
          box-shadow: none;
        }

        button:hover,
        button:active {
          box-shadow: none;
        }
      }

      .status {
        position: fixed;
        left: 50%;
        bottom: 120px;
        transform: translateX(-50%);
        z-index: 2;
        font-size: 12px;
        color: #a1a6aa;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        letter-spacing: 0.1em;
        text-transform: uppercase;
      }

      small {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.7);
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <main>
      <a class="promo-banner" href="https://card.jgoon.com/preview"
        >CHECK OUT A PREVIEW</a
      >
      <div class="preview-frame-wrapper">
        <iframe
          id="preview-frame"
          title="Editable card preview"
          sandbox="allow-same-origin allow-scripts"
        ></iframe>
      </div>
      <div class="overlay-controls">
        <button type="button" id="export-button" disabled>
          EXPORT YOUR CARD
        </button>
        <button type="button" id="deploy-button" disabled>
          <svg
            class="deploy-button-icon"
            data-testid="geist-icon"
            height="16"
            stroke-linejoin="round"
            viewBox="0 0 16 16"
            width="16"
            style="color: currentcolor"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M8 1L16 15H0L8 1Z"
              fill="currentColor"
            ></path>
          </svg>
          DEPLOY YOUR OWN
        </button>
      </div>
      <div class="status" data-state="loading" id="status-indicator">
        click any text on the card to edit
      </div>
    </main>
    <script>
      const FIELD_CONFIGS = [
        {
          id: "phone",
          label: "Phone number",
          selector: ".card__phone",
        },
        {
          id: "companyWordLeft",
          label: "Company word (left)",
          selector: ".card__company-word",
          index: 0,
        },
        {
          id: "companyAmpersand",
          label: "Company ampersand",
          selector: ".card__company-ampersand",
        },
        {
          id: "companyWordRight",
          label: "Company word (right)",
          selector: ".card__company-word",
          index: 1,
        },
        {
          id: "companyTagline",
          label: "Company tagline",
          selector: ".card__company-tagline",
        },
        {
          id: "personFirst",
          label: "First name",
          selector: ".card__person-first",
        },
        {
          id: "personLast",
          label: "Last name",
          selector: ".card__person-last",
        },
        {
          id: "title",
          label: "Title",
          selector: ".card__title",
        },
        {
          id: "address",
          label: "Address",
          selector: ".card__bottom-address",
        },
        {
          id: "faxLabel",
          label: "Fax label",
          selector: ".card__bottom-contact--fax .card__bottom-label",
        },
        {
          id: "faxValue",
          label: "Fax value",
          selector: ".card__bottom-contact--fax .card__bottom-value",
        },
        {
          id: "telexLabel",
          label: "Telex label",
          selector: ".card__bottom-contact--telex .card__bottom-label",
        },
        {
          id: "telexValue",
          label: "Telex value",
          selector: ".card__bottom-contact--telex .card__bottom-value",
        },
      ];

      const parser = new DOMParser();
      const statusIndicator = document.getElementById("status-indicator");
      const previewFrame = document.getElementById("preview-frame");
      const exportButton = document.getElementById("export-button");
      const deployButton = document.getElementById("deploy-button");

      let templateHTML = "";
      let frameDoc = null;
      let fieldValues = {};

      function setStatus(state, message) {
        statusIndicator.dataset.state = state;
        statusIndicator.textContent = message;
      }

      function getNode(doc, config) {
        if (config.selector) {
          if (typeof config.index === "number") {
            const nodes = doc.querySelectorAll(config.selector);
            return nodes[config.index] ?? null;
          }
          return doc.querySelector(config.selector);
        }
        return null;
      }

      function readField(doc, config) {
        const node = getNode(doc, config);
        if (!node) return "";
        if (typeof config.get === "function") {
          return config.get(doc);
        }
        if (config.attr) {
          return node.getAttribute(config.attr) ?? "";
        }
        return node.textContent.trim();
      }

      function writeField(doc, config, value) {
        if (typeof config.set === "function") {
          config.set(doc, value);
          return;
        }
        const node = getNode(doc, config);
        if (!node) return;
        if (config.attr) {
          node.setAttribute(config.attr, value ?? "");
          return;
        }
        node.textContent = value ?? "";
      }

      function sanitizeValue(value) {
        if (typeof value !== "string") return "";
        return value.replace(/\s+/g, " ").trim();
      }

      function sanitizeFieldValue(config, value) {
        return sanitizeValue(value);
      }

      function handlePastePlain(event) {
        event.preventDefault();
        const text = event.clipboardData?.getData("text/plain") ?? "";
        const doc = event.target?.ownerDocument;
        if (!doc) return;
        const selection = doc.getSelection();
        if (!selection || selection.rangeCount === 0) return;
        selection.deleteFromDocument();
        const range = selection.getRangeAt(0);
        range.insertNode(doc.createTextNode(text));
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
      }

      function initializeEditableFrame() {
        frameDoc = previewFrame.contentDocument;
        if (!frameDoc) {
          setStatus(
            "error",
            "Unable to access preview frame. Serve this directory with `python -m http.server`."
          );
          return;
        }

        const editableStyle = frameDoc.createElement("style");
        editableStyle.textContent = `
          [data-field-editor] {
            caret-color: #2f2b25;
            cursor: text;
          }

          [data-field-editor]:focus {
            outline: none;
            box-shadow: inset 0 -2px 0 rgba(56, 189, 248, 0.35);
          }
        `;
        frameDoc.head.appendChild(editableStyle);

        FIELD_CONFIGS.forEach((config) => {
          const node = getNode(frameDoc, config);
          if (!node) return;
          node.setAttribute("contenteditable", "plaintext-only");
          node.setAttribute("spellcheck", "false");
          node.dataset.fieldEditor = config.id;
          if (!node.hasAttribute("data-placeholder")) {
            node.setAttribute(
              "data-placeholder",
              config.label ?? "Click to edit"
            );
          }
          node.addEventListener("paste", handlePastePlain);
          node.addEventListener("input", () => {
            const sanitized = sanitizeFieldValue(
              config,
              node.textContent ?? ""
            );
            fieldValues[config.id] = sanitized;
          });
          node.addEventListener("blur", () => {
            const sanitized = sanitizeFieldValue(
              config,
              node.textContent ?? ""
            );
            fieldValues[config.id] = sanitized;
            writeField(frameDoc, config, sanitized);
          });
          const value = readField(frameDoc, config);
          fieldValues[config.id] = sanitizeFieldValue(config, value);
        });

        exportButton.disabled = false;
        if (deployButton) {
          deployButton.disabled = false;
        }
        setStatus("ready", "Click any text on the card to edit.");
      }

      async function loadTemplate() {
        try {
          setStatus("loading", "Loading template…");
          const response = await fetch("preview/index.html", {
            cache: "no-store",
          });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          templateHTML = await response.text();
          const previewDoc = parser.parseFromString(templateHTML, "text/html");
          previewDoc
            .querySelectorAll(".promo-banner")
            .forEach((banner) => banner.remove());
          previewFrame.srcdoc =
            "<!DOCTYPE html>\n" + previewDoc.documentElement.outerHTML;
        } catch (error) {
          console.error(error);
          setStatus(
            "error",
            "Could not load template (preview/index.html). Run a local web server (e.g. `python -m http.server`)."
          );
        }
      }

      function downloadFile() {
        if (!templateHTML) {
          setStatus("error", "Template not loaded. Unable to export.");
          return;
        }
        const doc = parser.parseFromString(templateHTML, "text/html");
        FIELD_CONFIGS.forEach((config) => {
          const value = fieldValues[config.id] ?? "";
          writeField(doc, config, value);
        });
        const first = (fieldValues.personFirst ?? "").trim();
        const last = (fieldValues.personLast ?? "").trim();
        const titleText = [first, last]
          .filter(Boolean)
          .map((part, index) =>
            index === 0
              ? part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
              : part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
          )
          .join(" ")
          .trim();
        if (titleText.length) {
          const titleEl = doc.querySelector("title");
          if (titleEl) {
            titleEl.textContent = titleText;
          }
        }
        const serialized = "<!DOCTYPE html>\n" + doc.documentElement.outerHTML;
        const safeName = [first, last]
          .filter(Boolean)
          .map(
            (part) => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
          )
          .join(" ")
          .trim();
        const fileName = safeName.length
          ? `${safeName}’s Card.html`
          : "index.html";
        const blob = new Blob([serialized], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement("a");
        anchor.href = url;
        anchor.download = fileName;
        document.body.appendChild(anchor);
        anchor.click();
        setTimeout(() => {
          document.body.removeChild(anchor);
          URL.revokeObjectURL(url);
        }, 0);
      }

      function createCommitMessage(values) {
        const first = (values.personFirst ?? "").trim();
        const last = (values.personLast ?? "").trim();
        const name = [first, last].filter(Boolean).join(" ");
        if (name.length) {
          return `chore: personalize card for ${name}`;
        }
        return "chore: update card preview";
      }

      async function deployToGitHub() {
        if (!deployButton) {
          return;
        }

        if (!templateHTML) {
          setStatus("error", "Template not loaded. Unable to deploy.");
          return;
        }

        deployButton.disabled = true;
        setStatus("loading", "Creating GitHub preview branch…");

        const payload = {
          fields: { ...fieldValues },
          commitMessage: `${createCommitMessage(
            fieldValues
          )} ${new Date().toISOString()}`,
        };

        try {
          const response = await fetch("/github/preview", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();
          const vercelUrl = result?.vercelImportUrl;
          const branchUrl = result?.branchUrl;

          if (vercelUrl) {
            setStatus("success", "Preview branch created! Opening Vercel…");
            window.open(vercelUrl, "_blank", "noopener");
          } else if (branchUrl) {
            setStatus("success", "Preview branch created! Opening GitHub…");
            window.open(branchUrl, "_blank", "noopener");
          } else {
            setStatus("success", "Preview branch created.");
          }
        } catch (error) {
          console.error("Failed to deploy preview branch.", error);
          setStatus(
            "error",
            "Unable to create GitHub preview branch. Check console/logs."
          );
        } finally {
          deployButton.disabled = false;
        }
      }

      exportButton.addEventListener("click", downloadFile);
      if (deployButton) {
        deployButton.addEventListener("click", deployToGitHub);
      }

      loadTemplate();

      previewFrame.addEventListener("load", () => {
        if (!templateHTML) return;
        initializeEditableFrame();
      });
    </script>
  </body>
</html>
